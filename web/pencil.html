<!doctype html>
<meta charset=utf-8>
<title> {{=title|html}} </title>

<link rel=stylesheet href=/cm/codemirror2012-04-15.css?plug=none>
<link rel=stylesheet href=/assets/common.css?plug=none>
<link rel=stylesheet href=/pencil/pencil.css?plug=none>

<body class=cm-s-default>

<div class=container id=wrapper></div>

<div id='toolbar' class='CodeMirror-gutter'>
  <nav id="location-zone">
    <div id=crumbs>{{-
      nav|crumb|i;
      <a href={{=crumb.path|uri}} class="crumb{{? i == 0; root-crumb}}">
        {{=crumb.name|html}}</a>}}
    </div>
  </nav>
  <div id="controls-zone">
    <div class=btn-group>
      <a class='btn disabled' id=undo title=undo>&#8630;</a>
      <a class='btn disabled' id=redo title=redo>&#8631;</a>
    </div>
    <div class=btn-group>
      <a class=btn title=settings
        href='{{=file.path|uri}}?plug=meta'>&#9881;</a>
      <a class=btn href='{{?
      file.mime === 'text/html';{{=file.path|uri}}?plug=none}}{{?
      file.mime === 'text/x-markdown';{{=file.path|uri}}?plug=showdown}}{{?
      file.mime === 'text/javascript';javascript:runJS()}}'
         title=run>&#9654;</a>
    </div>
    <div class=btn-group>
      <select onchange=selectTheme(this) title=theme>{{-
        ['default','night','neat','monokai','elegant',
         'cobalt','eclipse','rubyblue','lesser-dark','xq-dark']|theme|i;
        <option{{?theme===lookup('theme'); selected}}>{{=theme|html}}</option>}}
      </select>
    </div>
  </div>
</div>

<script src=/cm/codemirror2012-04-15.js?plug=none></script>
<script src=/$socket.io/socket.io.js></script>
<script src=/sc/scout.js?plug=none></script>
<script src=/ot/ot.js?plug=none></script>
<script src=/pencil/pencil.js?plug=none></script>

<script>
  (function () {
    var wrapper = Scout('#wrapper'), delay;

    // Templated information
    var socket = Scout.socket({{=file.path|json}}),
        mime = {{=file.mime|json}},
        theme = {{=lookup('theme')|json}} || 'default',
        keymap = {{=lookup('keymap')|json}} || 'default',
        lineNumbers = {{=lookup('lineNumbers')|json}} || true,
        lineWrapping = {{=lookup('lineWrapping')|json}} || true;

    function onChange() {
      postMessage(cm.getValue(), '*');

      // Use this instead if browser CPU load is too intense:
      /* clearTimeout(delay);
      delay = setTimeout(function () {
        postMessage(cm.getValue(), '*');
      }, 150); */

      if (cmClient) {
        maybeEnable(cmClient.undoStack, Scout('#undo'));
        maybeEnable(cmClient.redoStack, Scout('#redo'));
      }
    }

    // CodeMirror editor
    var cm = window.cm = CodeMirror(wrapper, {
      mode: mime,
      value: {{=file.content|json|script}},
      lineNumbers: lineNumbers,
      lineWrapping: lineWrapping,
      theme: theme,
      keyMap: keymap,
      onChange: onChange
    });

    // Operational Transformation
    var cmClient = new ot.CodeMirrorClient(socket, cm);
    wrapper.appendChild(cmClient.clientListEl);

    // CodeMirror themes
    cm.setTheme = function(theme) {
      cm.setOption('theme', theme);
      document.body.className =
        document.body.className.replace(/cm-s-\w+/, 'cm-s-' + theme);
    };
    cm.setTheme(theme);

    switch(mime) {
      case 'text/html':
        Scout('#run').href = '{{=file.path|uri}}?plug=none' ;
        break;
      case 'text/x-markdown': 
        Scout('#run').href = '{{=file.path|uri}}?plug=showdown';
        break;
      case 'text/javascript':
        Scout('#run').onclick = function(e) { runJS(); stopEvent(e) };
        break;
    }
  })();

</script>

<!-- Google Analytics -->
<script>var _gaq=_gaq||[];_gaq.push(['_setAccount','UA-27876347-1']);_gaq.push(['_trackPageview']);(function(){var ga=document.createElement('script');ga.type='text/javascript';ga.async=true;ga.src=('https:'==document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ga,s);})()</script>
