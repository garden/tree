<!doctype html>
<html>

<head>
  <meta charset=utf-8>
  <title> {{=title|html}} </title>
  <link rel=stylesheet href=/cm/codemirror2012-04-15.css?plug=none>
  <style>
    h1 {
      font-size: 48px; line-height: 64px;
      margin: 8px 0;
    }
    .CodeMirror-scroll {
      height: 600px;
    }
    .other-user {
      position: absolute;
      background: #aaa;
      width: auto;
    }
    .other-user pre {
      border-left: 1px solid #aaa;
      position: absolute; bottom: 100%;
    }
    .other-user-selection {
      background: rgba(200, 200, 200, 0.4);
    }
  </style>
</head>

<body>
  <div class="container" id="wrapper">
    <h1>Collaborative editing with CodeMirror</h1>
  </div>

  <script src=/cm/codemirror2012-04-15.js?plug=none></script>
  <script src=/$socket.io/socket.io.js></script>
  <script src=/sc/scout.js?plug=none></script>
  <script src=/ot/ot.js?plug=none></script>

  <script>
    (function () {
      var CodeMirrorClient = ot.CodeMirrorClient;

      var socket = Scout.socket({{=file.path|json}});

      // uncomment to simulate more latency
      /*(function () {
        var emit = socket.emit;
        var queue = [];
        socket.emit = function () {
          queue.push(arguments);
        };
        setInterval(function () {
          if (queue.length) {
            emit.apply(socket, queue.shift());
          }
        }, 800);
      })();*/

      var name = {{=user|json}};

      socket.emit('auth', { name: name });

      socket.once('doc', function (obj) {
        var str = obj.str, revision = obj.revision, users = obj.users;

        var wrapper = document.getElementById('wrapper');

        var cm = window.cm = CodeMirror(wrapper, {
          mode: {{=file.mime|json}},
          value: str,
          content: {{=file.content|json|html}},
          lineNumbers: true,
          lineWrapping: true,
          theme: {{=lookup('theme')|json}} || 'default'
        });

        var cmClient = new CodeMirrorClient(revision, cm, socket, name, users);
      });
    })();
  </script>

</body>

</html>
